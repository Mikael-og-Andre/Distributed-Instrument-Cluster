@layout NothingLayout
@using System.Net.WebSockets
@using System.Text
@using System.Threading
@using Server_Library
@implements IDisposable
@inject NavigationManager navigationManager

<img src="@imgsrc" style="width: 100%; height: 100%; position: absolute; top: 0; left: 0" />

@code {
    readonly CancellationTokenSource disposalTokenSource = new();           //Disposal token for async communication
    readonly ClientWebSocket videoWebSocket = new();                        //Client websocket
    bool foundDevice = false;                                               //Was the requested device found or not

    [Parameter]
    public string name { get; set; }                                        //Name of the wanted device
    [Parameter]
    public string location {get; set; }
    [Parameter]
    public string type { get; set; }
    [Parameter]
    public string subname { get; set; }


    private string imgsrc = "";                                             //img to show
    private int frameBufferSize = 200000;                                   //Buffer for incoming msg's

    string pathToVideoWebsocket = "videoStream";


    protected override async Task OnInitializedAsync() {
        //Get base uri and connect to that
        string basePath = navigationManager.BaseUri;
        basePath = basePath.Replace("https://", "wss://");

        await videoWebSocket.ConnectAsync(new Uri(basePath+pathToVideoWebsocket), disposalTokenSource.Token);

        //Sends name and setsup socket
        foundDevice = await SetupSocket();

        //Start the video receive loop
        if (foundDevice) {
            Console.WriteLine("Found device, Accepting incoming frames");
            _ = ReceiveVideo();
        }
        else {
            Console.WriteLine("Device was with name {0} was not found by server, Or another error occurred with the websocket", name);
        }
    }

    /// <summary>
    /// Start Receiving video
    /// </summary>
    /// <returns></returns>
    async Task ReceiveVideo() {
        try {
            while (!disposalTokenSource.IsCancellationRequested) {
                var buffer = new ArraySegment<byte>(new byte[frameBufferSize]);
                var received = await videoWebSocket.ReceiveAsync(buffer, disposalTokenSource.Token);
                Console.WriteLine(buffer);
                var frame = new VideoFrame(new byte[] { });
                frame = (VideoFrame)frame.getObject(buffer.ToArray());
                Console.WriteLine(frame.value.Length);

                var base64 = Convert.ToBase64String(frame.value);
                imgsrc = string.Format("data:image/jpg;base64,{0}", base64);

                StateHasChanged();
            }
        }
        catch (Exception ex) {
            Console.WriteLine("Exception thrown: " + ex.Message);
        }

    }

    /// <summary>
    /// Sets up the socket, send name of wanted device, and receive if it was found or not
    /// </summary>
    /// <returns></returns>
    private async Task<bool> SetupSocket() {
        try {
            //Receive start signal
            byte[] startBuffer = new byte[1024];
            ArraySegment<byte> startSignalBuffer = new ArraySegment<byte>(startBuffer);
            await videoWebSocket.ReceiveAsync(startSignalBuffer, disposalTokenSource.Token);

            //Send name
            ArraySegment<byte> nameBytes = new ArraySegment<byte>(Encoding.UTF8.GetBytes(name));
            await videoWebSocket.SendAsync(nameBytes, WebSocketMessageType.Text, true, disposalTokenSource.Token);

            //Send location
            ArraySegment<byte> locationBytes = new ArraySegment<byte>(Encoding.UTF8.GetBytes(location));
            await videoWebSocket.SendAsync(locationBytes, WebSocketMessageType.Text, true, disposalTokenSource.Token);

            //Send type
            ArraySegment<byte> typeBytes = new ArraySegment<byte>(Encoding.UTF8.GetBytes(type));
            await videoWebSocket.SendAsync(typeBytes, WebSocketMessageType.Text, true, disposalTokenSource.Token);

            //Send subanme
            ArraySegment<byte> subnameBytes = new ArraySegment<byte>(Encoding.UTF8.GetBytes(subname));
            await videoWebSocket.SendAsync(subnameBytes, WebSocketMessageType.Text, true, disposalTokenSource.Token);

            //Get found or not
            byte[] foundBuffer = new byte[1024];
            ArraySegment<byte> foundBytes = new ArraySegment<byte>(foundBuffer);
            await videoWebSocket.ReceiveAsync(foundBytes, disposalTokenSource.Token);
            string found = Encoding.UTF8.GetString(foundBytes).TrimEnd('\0');

            return found.ToLower().Equals("found".ToLower());
        }
        catch (Exception) {
            return false;
        }

    }

    public void Dispose() {
        disposalTokenSource.Cancel();
        _ = videoWebSocket.CloseAsync(WebSocketCloseStatus.NormalClosure, "Bye", CancellationToken.None);
    }

}